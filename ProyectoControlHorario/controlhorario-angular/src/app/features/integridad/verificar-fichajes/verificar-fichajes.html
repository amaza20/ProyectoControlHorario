<nav class="navbar">
  <div class="nav-brand">ğŸ• Control Horario</div>
  <div class="nav-user">{{ (authService.currentUser$ | async)?.username }} ({{ (authService.currentUser$ | async)?.rol }})</div>
</nav>

<div class="container" style="margin-top: 100px;">
  <div class="back-link">
    <a (click)="goToDashboard()" style="cursor: pointer;">â† Volver al Dashboard</a>
  </div>

  <div style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto;">
    <h1 style="text-align: center; margin-bottom: 10px;">ğŸ” Verificar Integridad de Fichajes</h1>
    <p style="text-align: center; color: #666; margin-bottom: 30px;">
      Comprueba la autenticidad de los registros mediante blockchain
    </p>

    <form (ngSubmit)="verificarIntegridad()">
      <div class="form-group">
        <label for="departamento">Departamento a Verificar *</label>
        <select 
          id="departamento"
          name="departamento"
          [(ngModel)]="departamentoSeleccionado"
          required
          [disabled]="isLoadingDepartamentos || (authService.getCurrentUser()?.rol === 'Auditor' || authService.getCurrentUser()?.rol === 'Supervisor')"
          [style.background]="(authService.getCurrentUser()?.rol === 'Auditor' || authService.getCurrentUser()?.rol === 'Supervisor') ? '#f0f0f0' :  ''">
          <option value="">Selecciona un departamento</option>
          <option *ngFor="let dept of departamentos" [value]="dept">{{ dept }}</option>
        </select>
        <small *ngIf="departamentos.length === 1" style="color: #666; display: block; margin-top: 5px;">
          â„¹ï¸ Solo puedes verificar la integridad de tu departamento
        </small>
      </div>

      <button type="submit" class="btn btn-primary btn-block" [disabled]="isLoading || isLoadingDepartamentos">
        {{ isLoading ? 'ğŸ”„ Verificando.. .' : 'ğŸ” Verificar Integridad' }}
      </button>
    </form>

    <div *ngIf="errorMessage" class="response error" style="display: block; margin-top: 20px;">
      {{ errorMessage }}
    </div>
  </div>

  <!-- Resultados -->
  <div *ngIf="mostrarResultados && ! isLoading" style="margin-top: 30px;">
    <!-- Header de resultado -->
    <div *ngIf="getCorruptos() === 0" 
         style="background: #d4edda; border: 2px solid #28a745; border-radius: 8px; padding: 20px; margin-bottom: 20px; text-align: center;">
      <div style="font-size: 3em; margin-bottom: 10px;">âœ…</div>
      <h2 style="color: #155724; margin: 0;">Â¡Integridad Verificada!</h2>
      <p style="color: #155724; margin-top: 10px;">
        Todos los <strong>{{ fichajes.length }}</strong> fichajes del departamento 
        <strong>{{ departamentoSeleccionado }}</strong> son vÃ¡lidos y autÃ©nticos.
      </p>
    </div>

    <div *ngIf="getCorruptos() > 0" 
         style="background: #f8d7da; border: 2px solid #dc3545; border-radius: 8px; padding: 20px; margin-bottom: 20px; text-align: center;">
      <div style="font-size: 3em; margin-bottom: 10px;">âš ï¸</div>
      <h2 style="color:  #721c24; margin: 0;">Â¡Integridad Comprometida!</h2>
      <p style="color: #721c24; margin-top: 10px;">
        Se detectaron <strong>{{ getCorruptos() }}</strong> fichaje(s) con inconsistencias de un total de 
        <strong>{{ fichajes.length }}</strong> en el departamento <strong>{{ departamentoSeleccionado }}</strong>.
      </p>
    </div>

    <!-- Tabla -->
    <div *ngIf="fichajes.length > 0" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
      <h3 style="margin-bottom: 15px;">ğŸ“Š Detalle de Fichajes (ordenados por ID):</h3>
      
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th style="text-align: center;">ID</th>
              <th>Usuario</th>
              <th>Fecha/Hora Original</th>
              <th>Fecha/Hora Editada</th>
              <th style="text-align: center;">Tipo</th>
              <th style="min-width: 250px;">Huella Guardada</th>
              <th style="min-width: 250px;">Huella Calculada</th>
              <th style="text-align: center;">Estado</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let fichaje of fichajes; let i = index"
                [style.background-color]="esCorrupto(fichaje) ? '#fff5f5' : (i % 2 === 0 ? '#f8f9fa' : 'white')"
                [style.border-left]="esCorrupto(fichaje) ? '4px solid #dc3545' : 'none'">
              
              <td style="text-align: center;"><strong>{{ fichaje.id }}</strong></td>
              <td>{{ fichaje.username || fichaje.usuario }}</td>
              <td>{{ fichaje.fechaHora_original | fechaLocal }}</td>
              <td>
                <span *ngIf="fichaje.fechaHora_editado" style="color: #007bff; font-weight: 500;">
                  {{ fichaje.fechaHora_editado | fechaLocal }}
                </span>
                <span *ngIf="! fichaje.fechaHora_editado" style="color: #999; font-style: italic;">
                  Sin ediciÃ³n
                </span>
              </td>
              <td style="text-align: center;">
                <strong style="background: #e3f2fd; padding: 4px 8px; border-radius: 4px;">{{ fichaje.tipo }}</strong>
              </td>
              
              <!-- Huella Guardada -->
              <td>
                <div [style.background-color]="huellasCoinciden(fichaje) ? '#d4edda' : '#f8d7da'"
                     [style.border]="huellasCoinciden(fichaje) ? '1px solid #28a745' : '1px solid #dc3545'"
                     style="padding: 8px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 0.8em; word-break: break-all;">
                  <div style="font-weight: bold; margin-bottom: 4px; color: #555;">ğŸ’¾ Guardada: </div>
                  <span [title]="fichaje.huellaGuardada" style="cursor: help;">
                    {{ abreviarHuella(fichaje.huellaGuardada) }}
                  </span>
                </div>
              </td>
              
              <!-- Huella Calculada -->
              <td>
                <div [style.background-color]="huellasCoinciden(fichaje) ? '#d4edda' :  '#f8d7da'"
                     [style.border]="huellasCoinciden(fichaje) ? '1px solid #28a745' : '1px solid #dc3545'"
                     style="padding: 8px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 0.8em; word-break: break-all;">
                  <div style="font-weight: bold; margin-bottom: 4px; color: #555;">ğŸ”¢ Calculada:</div>
                  <span [title]="fichaje.huellaCalculada" style="cursor: help;">
                    {{ abreviarHuella(fichaje.huellaCalculada) }}
                  </span>
                </div>
              </td>
              
              <!-- Estado -->
              <td style="text-align: center;">
                <span *ngIf="esCorrupto(fichaje)" 
                      style="background: #f8d7da; color: #721c24; padding: 6px 12px; border-radius: 4px; font-weight: bold; display: inline-block;">
                  âš ï¸ {{ fichaje.mensaje || fichaje.estado }}
                </span>
                <span *ngIf="!esCorrupto(fichaje)" 
                      style="background: #d4edda; color: #155724; padding: 6px 12px; border-radius: 4px; font-weight: bold; display: inline-block;">
                  âœ… {{ fichaje.mensaje || fichaje. estado }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- PaginaciÃ³n (similar a lista-fichajes) -->
      <div class="pagination-controls" style="margin-top: 20px;">
        <button class="btn btn-secondary" (click)="paginaAnterior()" [disabled]="paginaActual === 0">â† Anterior</button>
        <span>PÃ¡gina {{ paginaActual + 1 }} ({{ fichajes.length }} fichaje{{ fichajes.length !== 1 ? 's' :  '' }})</span>
        <button class="btn btn-secondary" (click)="paginaSiguiente()" [disabled]="!hayMasPaginas">Siguiente â†’</button>
      </div>

      <div style="text-align: center; margin-top: 15px;">
        <label>Fichajes por pÃ¡gina:</label>
        <select (change)="cambiarElementosPorPagina($event)" [value]="elementosPorPagina">
          <option [value]="5">5</option>
          <option [value]="10">10</option>
          <option [value]="20">20</option>
          <option [value]="50">50</option>
          <option [value]="100">100</option>
        </select>
      </div>

      <!-- Resumen -->
      <div [style.background-color]="getCorruptos() === 0 ? '#e7f3ff' : '#fff3cd'"
           style="margin-top: 20px; padding: 20px; border-radius: 8px; border-left: 4px solid #2196F3;">
        <strong>ğŸ“ˆ Resumen de VerificaciÃ³n:</strong>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
          <div>
            <div style="font-size: 0.9em; color: #666;">Fichajes vÃ¡lidos</div>
            <div style="font-size: 1.5em; font-weight: bold; color: #28a745;">âœ… {{ getValidos() }}</div>
          </div>
          <div>
            <div style="font-size: 0.9em; color: #666;">Fichajes con inconsistencias</div>
            <div style="font-size:  1.5em; font-weight: bold; color: #dc3545;">âš ï¸ {{ getCorruptos() }}</div>
          </div>
          <div>
            <div style="font-size: 0.9em; color: #666;">Total de fichajes</div>
            <div style="font-size: 1.5em; font-weight: bold; color: #333;">ğŸ“Š {{ fichajes.length }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sin fichajes -->
    <div *ngIf="fichajes.length === 0" style="background: white; padding: 40px; border-radius: 12px; text-align: center;">
      <p style="color: #666;">No hay fichajes en este departamento</p>
    </div>
  </div>
</div>
