<nav class="navbar">
  <div class="nav-brand">üïê Control Horario</div>
  <button mat-button class="back-btn" routerLink="/dashboard">
    <mat-icon>arrow_back</mat-icon> Volver
  </button>
</nav>

<div class="container">
  <div class="card">
    <h1>üìã Mis Fichajes</h1>
    <p class="subtitle">Consulta tu historial de fichajes</p>
    
    <!-- ‚úÖ Filtros de fecha para CSV -->
    <div style="display: flex; gap: 15px; margin-bottom: 15px; align-items: center; flex-wrap: wrap;">
      <mat-form-field appearance="outline" style="max-width: 200px;">
        <mat-label>Desde</mat-label>
        <input matInput type="date" [(ngModel)]="fechaDesde">
      </mat-form-field>
      
      <mat-form-field appearance="outline" style="max-width: 200px;">
        <mat-label>Hasta</mat-label>
        <input matInput type="date" [(ngModel)]="fechaHasta">
      </mat-form-field>
      
      <button mat-stroked-button color="warn" (click)="limpiarFiltros()" *ngIf="fechaDesde || fechaHasta">
        <mat-icon>clear</mat-icon> Limpiar filtros
      </button>
    </div>
    
    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
      <button mat-raised-button color="primary" (click)="cargarFichajes()" [disabled]="loading">
        üîÑ Actualizar Lista
      </button>
      <button mat-raised-button color="accent" (click)="descargarCSV()" [disabled]="loading || descargandoCSV || totalFichajes === 0">
        <mat-icon>download</mat-icon> {{ descargandoCSV ? 'Descargando...' : 'Descargar CSV' }}
      </button>
    </div>
    
    <div *ngIf="!loading && fichajes.length > 0" class="response success">
      ‚úÖ P√°gina {{ paginaActual + 1 }} de {{ totalPaginas }} | Total de fichajes: {{ totalFichajes }}
    </div>
    
    <div *ngIf="errorMessage" class="response error">
      {{ errorMessage }}
    </div>

    <div *ngIf="loading" class="loading-state">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Cargando fichajes...</p>
    </div>

    <div *ngIf="!loading && fichajes.length === 0 && !errorMessage" class="no-data">
      <mat-icon>inbox</mat-icon>
      <p>No hay fichajes registrados</p>
    </div>

    <div *ngIf="!loading && fichajes.length > 0" class="table-wrapper">
      <table class="fichajes-table">
        <thead>
          <tr>
            <th>Fecha y Hora</th>
            <th>Tipo</th>
            <th>Estado</th>
            <th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let fichaje of fichajes">
            <td>
              <div *ngIf="fichaje.aprobadoEdicion === 'APROBADO'">
                <div style="color: #dc3545; text-decoration: line-through; font-size: 0.85em;">
                  {{ fichaje.instanteAnterior | fechaLocal }}
                </div>
                <div style="color: #28a745; font-weight: bold;">
                  {{ fichaje.nuevoInstante | fechaLocal }}
                </div>
              </div>
              <div *ngIf="fichaje.aprobadoEdicion === 'PENDIENTE'">
                <div style="color: #333; font-weight: 500;">{{ (fichaje.nuevoInstante || fichaje.instanteAnterior) | fechaLocal }}</div>
                <div style="display: flex; align-items: center; gap: 5px; margin-top: 5px;">
                  <span style="color: #856404; font-size: 0.9em;">‚Üí</span>
                  <span style="color: #856404; font-weight: 600; font-size: 0.95em;">{{ fichaje.solicitudInstante | fechaLocal }}</span>
                </div>
              </div>
              <!-- Si fue rechazado, mostrar solo el fichaje original (sin indicar que hubo rechazo) -->
              <div *ngIf="fichaje.aprobadoEdicion === 'RECHAZADO' || !fichaje.aprobadoEdicion">
                {{ fichaje.instanteAnterior | fechaLocal }}
              </div>
            </td>
            <td>
              <div *ngIf="fichaje.aprobadoEdicion === 'APROBADO'">
                <div style="color: #dc3545; text-decoration: line-through; font-size: 0.85em;">
                  {{ fichaje.tipoAnterior }}
                </div>
                <div style="color: #28a745; font-weight: bold;">
                  {{ fichaje.nuevoTipo }}
                </div>
              </div>
              <div *ngIf="fichaje.aprobadoEdicion === 'PENDIENTE'">
                <div style="color: #333;">{{ fichaje.nuevoTipo || fichaje.tipoAnterior }}</div>
                <div style="display: flex; align-items: center; gap: 5px; margin-top: 5px;">
                  <span style="color: #856404; font-size: 0.9em;">‚Üí</span>
                  <span style="color: #856404; font-weight: 600; font-size: 0.95em;">{{ fichaje.solicitudTipo }}</span>
                </div>
              </div>
              <span *ngIf="fichaje.aprobadoEdicion !== 'APROBADO' && fichaje.aprobadoEdicion !== 'PENDIENTE'" 
                    class="tipo-badge" 
                    [class.entrada]="(fichaje.nuevoTipo || fichaje.tipoAnterior) === 'ENTRADA'" 
                    [class.salida]="(fichaje.nuevoTipo || fichaje.tipoAnterior) === 'SALIDA'">
                {{ fichaje.nuevoTipo || fichaje.tipoAnterior }}
              </span>
            </td>
            <td>
              <span class="estado-badge" [ngClass]="getEstadoClass(fichaje)">
                {{ getEstadoTexto(fichaje) }}
              </span>
            </td>
            <td>
              <button mat-raised-button 
                      color="accent" 
                      (click)="editarFichaje(fichaje)" 
                      [disabled]="fichaje.aprobadoEdicion === 'PENDIENTE'"
                      [class.btn-disabled]="fichaje.aprobadoEdicion === 'PENDIENTE'"
                      class="btn-editar">
                <span *ngIf="fichaje.aprobadoEdicion === 'PENDIENTE'">‚è≥ En tr√°mite</span>
                <span *ngIf="fichaje.aprobadoEdicion !== 'PENDIENTE'">‚úèÔ∏è Editar</span>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="pagination-controls" *ngIf="!loading && fichajes.length > 0">
      <button (click)="irAPagina(0)" [disabled]="paginaActual === 0" class="page-btn">&lt;&lt;</button>
      <button (click)="irAPagina(paginaActual - 1)" [disabled]="paginaActual === 0" class="page-btn">&lt;</button>
      
      <select [(ngModel)]="paginaActual" (change)="cambiarPagina()" class="page-selector">
        <option *ngFor="let p of generarPaginas()" [value]="p">{{ p + 1 }}</option>
      </select>
      
      <button (click)="irAPagina(paginaActual + 1)" [disabled]="paginaActual >= totalPaginas - 1" class="page-btn">&gt;</button>
      <button (click)="irAPagina(totalPaginas - 1)" [disabled]="paginaActual >= totalPaginas - 1" class="page-btn">&gt;&gt;</button>
      
      <span class="separator">|</span>
      
      <label for="filasPorPagina">N√∫mero de filas:</label>
      <select id="filasPorPagina" [(ngModel)]="elementosPorPagina" (change)="cambiarElementosPorPagina()" class="rows-selector">
        <option [value]="5">5</option>
        <option [value]="10">10</option>
        <option [value]="20">20</option>
        <option [value]="25">25</option>
        <option [value]="50">50</option>
      </select>
    </div>

    <div class="info-box">
      <strong>‚ÑπÔ∏è Informaci√≥n sobre estados:</strong>
      <ul>
        <li><strong>üìã Original:</strong> Fichaje sin modificaciones. Puedes solicitar una edici√≥n</li>
        <li><strong>‚è≥ Pendiente:</strong> Solicitud de edici√≥n en espera de aprobaci√≥n del supervisor. No puedes solicitar otra edici√≥n hasta que se resuelva</li>
        <li><strong>‚ùå Rechazado:</strong> Solicitud de edici√≥n denegada por el supervisor. Puedes solicitar una nueva edici√≥n</li>
        <li><strong>‚úèÔ∏è Editado:</strong> Edici√≥n aprobada. El valor original aparece tachado y el nuevo en verde. Puedes solicitar otra edici√≥n si es necesario</li>
      </ul>
    </div>
  </div>
</div>
